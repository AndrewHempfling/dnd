<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg==" crossorigin="anonymous" />

    <title>world 8</title>

    <style>
        body {
            margin: 0;
        }
        
        #spinnerParent {
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background-color: #00000080;
            left: 0px;
            top: 0px;
            z-index: 99999;
        }
        
        input[type="color"] {
            height: 2rem;
        }
    </style>
</head>

<body>
    <div id="spinnerParent">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3">Loading...</div>
    </div>

    <nav class="navbar fixed-bottom navbar-light bg-light">

        <div class="container-fluid">
            <div class="form-inline">


                <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMapSettings" aria-controls="offcanvasMapSettings">
                    <i class="fas fa-sliders-h" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMapSettings" aria-controls="offcanvasMapSettings"></i>
                </button>

                <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWorldSettings" aria-controls="offcanvasWorldSettings">
                    <i class="fas fa-globe" aria-hidden="true" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWorldSettings" aria-controls="offcanvasWorldSettings"></i>
                </button>

                <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasColorSettings" aria-controls="offcanvasColorSettings">
                    <i class="fas fa-palette" data-bs-toggle="offcanvas" data-bs-target="#offcanvasColorSettings" aria-controls="offcanvasColorSettings"></i>
                </button>

                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mapDrawingModal">
                    <i class="fas fa-scroll"></i>
                  </button>

            </div>
        </div>
    </nav>

    <div class="row p-0 m-0 w-100">
        <div class="col w-100 p-0 m-0" id="3d">
        </div>
    </div>

    <div class="offcanvas offcanvas-bottom h-75" tabindex="-1" id="offcanvasMapSettings" aria-labelledby="offcanvasMapSettingsLabel">
        <div class="offcanvas-header py-2 border-bottom">
            <h5 class="offcanvas-title" id="offcanvasMapSettingsLabel">Settings</h5>
            <button type="button" class="btn-close text-reset pt-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <label for="frequency" class="form-label">Frequency <span class="text-muted" id="valOffrequency"></span></label>
            <input type="range" class="form-range" id="frequency" min="1" max="100" value="25">

            <label for="persistence" class="form-label">Persistence <span class="text-muted" id="valOfpersistence"></span></label>
            <input type="range" class="form-range" id="persistence" min="1" max="100" value="75">

            <label for="octaves" class="form-label">Octaves <span class="text-muted" id="valOfoctaves"></span></label>
            <input type="range" class="form-range" id="octaves" min="1" max="16" value="9">

            <label for="amplitude" class="form-label">Amplitude <span class="text-muted" id="valOfamplitude"></span></label>
            <input type="range" class="form-range" id="amplitude" min="1" max="10" value="8">

            <button class="btn btn-primary generate-btn float-end" id="generateSettings" type="button" data-bs-dismiss="offcanvas" aria-label="Close">Generate</button>

        </div>
    </div>

    <div class="offcanvas offcanvas-bottom h-75" tabindex="-1" id="offcanvasWorldSettings" aria-labelledby="offcanvasWorldSettingsLabel">
        <div class="offcanvas-header py-2 border-bottom">
            <h5 class="offcanvas-title" id="offcanvasWorldSettingsLabel">Settings</h5>
            <button type="button" class="btn-close text-reset pt-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <label for="permutation" class="form-label">Permutation <span class="text-muted" id="valOfpermutation"></span></label>
            <input type="range" class="form-range" id="permutation" min="0" max="10000" value="5000">

            <label for="seaLevel" class="form-label">Sea Level <span class="text-muted" id="valOfseaLevel"></span></label>
            <input type="range" class="form-range" id="seaLevel" min="0" max="100" value="58">

            <label for="scale" class="form-label">Scale <span class="text-muted" id="valOfscale"></span></label>
            <input type="range" class="form-range" id="scale" min="1" max="100" value="10">

            <label for="bias" class="form-label">Bias <span class="text-muted" id="valOfbias"></span></label>
            <input type="range" class="form-range" id="bias" min="1" max="100" value="1">

            <button class="btn btn-primary generate-btn float-end" id="generateSettings" type="button" data-bs-dismiss="offcanvas" aria-label="Close">Generate</button>

        </div>
    </div>


    <div class="offcanvas offcanvas-bottom h-75" tabindex="-1" id="offcanvasColorSettings" aria-labelledby="offcanvasColorSettingsLabel">
        <div class="offcanvas-header py-2 border-bottom">
            <h5 class="offcanvas-title" id="offcanvasColorSettingsLabel">Color Settings</h5>
            <button type="button" class="btn-close text-reset pt-3" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">

            <input type="color" class="form-control p-0" id="color" value="#001446">
            <input type="color" class="form-control p-0" id="color" value="#05466C">
            <input type="color" class="form-control p-0" id="color" value="#001446">
            <input type="color" class="form-control p-0" id="color" value="#9F987A">
            <input type="color" class="form-control p-0" id="color" value="#56393C">

            <div class="input-group mb-3">
                <span class="input-group-text py-0" id="basic-addon1">@</span>
                <input type="color" class="form-control p-0" id="color" value="#56003C">
            </div>
        </div>

        <button class="btn btn-primary generate-btn float-end" id="generateColors" type="button" data-bs-dismiss="offcanvas" aria-label="Close">Generate</button>
    </div>

    <div class="modal fade" id="mapDrawingModal" tabindex="-1" aria-labelledby="mapDrawingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mapDrawingModalLabel">Map</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <canvas id="canvas_landscape" width="720" height="480"></canvas>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-start" id="zoomtst">zoom</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>


    <canvas id="canvas_displace" width="720" height="480" style="display: none;"></canvas>
    <canvas id="canvas_reflective" width="720" height="480" style="display: none"></canvas>
    <canvas id="canvas_albedo" width="720" height="480" style="display: none"></canvas>
    <canvas id="canvas_vegetation" width="720" height="480" style="display: none"></canvas>
    <canvas id="composite" height="480" width="720" style="display: none"></canvas>
    <canvas id="canvas_drawing" width="720" height="480" style="display: none;"></canvas>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" integrity="sha512-dLxUelApnYxpLt6K2iomGngnHO83iUvZytA3YjDUCjT0HDOHKXnVYdf3hU4JjM8uEhxf9nD1/ey98U3t2vZ0qQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="/dnd/maps/js/orbit-controls.js"></script>

    <script src="https://unpkg.com/simplex-noise@2.4.0/simplex-noise.js"></script>
    <script src="/dnd/maps/js/generate-noise2.js"></script>


    <script>
        var frequency = $('#frequency').val() / 200;
        var octaves = $('#octaves').val();
        var amplitude = $('#amplitude').val() / 10;
        var persistence = $('#persistence').val() / 100;
        var scale = $('#scale').val() / 100;
        var bias = $('#bias').val() / 100;
        var seaLevel = $('#seaLevel').val() / 100;
        var permutation = $('#permutation').val();

        $('#valOfpermutation').html(permutation);
        $('#valOffrequency').html(frequency * 2);
        $('#valOfoctaves').html(octaves);
        $('#valOfamplitude').html(amplitude);
        $('#valOfpersistence').html(persistence);
        $('#valOfscale').html(scale);
        $('#valOfbias').html(bias);
        $('#valOfseaLevel').html($('#seaLevel').val() + '%');

        noise(permutation);

        const material = new THREE.MeshStandardMaterial();
        const loader = new THREE.AnimationLoader();
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(24, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.z = 10;
        const renderer = new THREE.WebGLRenderer();

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.minDistance = 2.4;
        controls.maxDistance = 20;
        controls.enableDamping = true;
        controls.dampingFactor = .1;
        controls.rotateSpeed = 0.08;
        controls.update();

        renderer.setSize(window.innerWidth, window.innerHeight);
        var geometry = new THREE.SphereGeometry(1, canvas_displace.width, canvas_displace.height);
        var sphere = new THREE.Mesh(geometry, material);

        scene.add(sphere);

        const animate = function() {
            controls.update();
            requestAnimationFrame(animate);

            sphere.rotation.y -= 0.001;
            //sphere.rotation.x += 0.01;

            renderer.render(scene, camera);
        };

        animate();
        renderer.render(scene, camera);
        $('#3d')[0].appendChild(renderer.domElement);

        const directionalLight = new THREE.DirectionalLight(0xfdfeda, 1.5);
        directionalLight.position.set(1500, 1000, -100);
        scene.add(directionalLight);

        const ambientLight = new THREE.AmbientLight(0x999999);
        scene.add(ambientLight);

        function loadMaterials() {
            var canvas_landscape = document.getElementById('canvas_landscape');
            var dataURL_displace = canvas_displace.toDataURL();

            var loader_displace = new THREE.TextureLoader();

            loader_displace.load(
                dataURL_displace,
                function(dataURL_displace) {
                    dataURL_displace.needsUpdate = true;
                    material.needsUpdate = true
                        //material.map = dataURL_displace;
                    material.displacementMap = dataURL_displace;
                    material.displacementScale = scale;
                    material.displacementBias = bias;
                },

                undefined,

                function(err) {
                    console.error('An error happened.');
                }
            );

            var loader_albedo = new THREE.TextureLoader();

            var dataURL_albedo = canvas_albedo.toDataURL();
            var dataURL_landscape = canvas_landscape.toDataURL();

            loader_albedo.load(
                dataURL_landscape,

                function(dataURL_landscape) {
                    var landscapeImg = dataURL_landscape.image;
                    //mapDrawingBody
                    //$('#mapDrawingBody').html($(landscapeImg).addClass('img-fluid').attr('id', 'mapImg'));
                    //$('#offcanvasmapDrawing').height($(dataURL_albedo.image).height())
                    //$('#mapDrawing').attr('src', dataURL_albedo);
                    dataURL_landscape.needsUpdate = true;
                    material.needsUpdate = true
                    material.map = dataURL_landscape;
                    var originalLandscape = canvas_landscape;

                    $('#canvas_landscape').on('click', function(e) {
                        console.log(e)
                    });

                    $('#canvas_landscape').on('mousewheel', function(e) {
                        //console.log(e.originalEvent)
                        wD = e.originalEvent.wheelDelta;

                        var context_Landscape = canvas_landscape.getContext('2d');

                        context_Landscape.scale(1 + (wD / 100 / canvas_landscape.width), 1 + (wD / 100 / canvas_landscape.height));
                        context_Landscape.drawImage(originalLandscape, 0, 0, 720, 480);
                    });
                    /*
                    $('#zoomtst').on('click', function() {
                        var img = new Image;
                        img.src = canvas_landscape.toDataURL();

                        var context = canvas_landscape.getContext('2d');
                        var originalHeight = canvas_landscape.height;
                        var originalWidth = canvas_landscape.width;

                        img.onload = function() {
                            //context.clearRect(0, 0, canvas_landscape.width, canvas_landscape.height);
                            context.drawImage(img, -300, -300, 7200, 4800);
                            $('#mapDrawingBody').html($(img).addClass('img-fluid'));
                        };


                    });
                    */
                },

                undefined,

                function(err) {
                    console.error('An error happened.');
                }
            );

            var loader_reflective = new THREE.TextureLoader();

            var dataURL_reflective = canvas_reflective.toDataURL();
            loader_reflective.load(
                dataURL_reflective,

                function(dataURL_reflective) {

                    dataURL_reflective.needsUpdate = true;
                    material.needsUpdate = true
                        //blue channel
                    material.metalnessMap
                    material.metalness = .3;
                    //green channel
                    material.roughnessMap
                    material.roughness = .7
                },

                undefined,

                function(err) {
                    console.error('An error happened.');
                }
            );
        }
        loadMaterials();

        $('.generate-btn').on('click', function(e) {
            noise(permutation);
            loadMaterials();

        });
    </script>

</body>

</html>